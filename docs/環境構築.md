# Poetry + pytest + mypy + Docker + Python 3.12 開発環境構築ガイド（VSCode Remote - Containers版）

このガイドでは、VSCode の Remote - Containers 拡張を用いて、Python 3.12 + Poetry + pytest + mypy 環境を Docker 上に構築する方法を紹介します。

---

## ✅ 前提条件

### Windows / macOS 共通

* [Docker Desktop](https://www.docker.com/products/docker-desktop/) をインストール
* [VSCode](https://code.visualstudio.com/) をインストール
* VSCode 拡張機能：

  * Remote - Containers
  * Python
  * Pylance

---

## 📁 プロジェクト構成

```
python_workshop/
├── .devcontainer/
│   ├── devcontainer.json
│   └── Dockerfile
├── pyproject.toml         # Poetryの定義ファイル
├── src/                   # Pythonコード置き場
│   └── main.py
```

---

## 📄 .devcontainer/devcontainer.json

```json
{
  "name": "Python 3.12 + Poetry",
  "build": {
    "dockerfile": "Dockerfile",
    "context": ".."
  },
  "settings": {
    "terminal.integrated.defaultProfile.linux": "bash"
  },
  "extensions": [
    "ms-python.python",
    "ms-python.vscode-pylance"
  ],
  "postCreateCommand": "poetry install --no-root",
  "remoteUser": "vscode"
}
```

---

## 📄 .devcontainer/Dockerfile

```dockerfile
FROM python:3.12-slim

RUN apt-get update && apt-get install -y \
    curl build-essential git && \
    apt-get clean

# Poetryのインストール（rootユーザーで）
RUN curl -sSL https://install.python-poetry.org | python3 - && \
    ln -s /root/.local/bin/poetry /usr/local/bin/poetry

ENV POETRY_VIRTUALENVS_CREATE=false

WORKDIR /workspace

COPY pyproject.toml poetry.lock* ./
RUN poetry install --no-root --no-interaction --no-ansi

COPY . .

# vscodeユーザーを追加（最後に切り替え）
RUN useradd -m vscode
USER vscode
```

---

## 📄 pyproject.toml

```toml
[tool.poetry]
name = "python_workshop"
version = "0.1.0"
description = "Python 3.12 + Poetry Dev Environment"
authors = ["Your Name <your@email.com>"]

[tool.poetry.dependencies]
python = "^3.12"

[tool.poetry.group.dev.dependencies]
pytest = "^8.0"
mypy = "^1.8"
flake8 = "^7.0"
black = "^24.3"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```

---

## 🧪 サンプルコード（src/main.py）

```python
def greet(name: str) -> str:
    return f"Hello, {name}!"

if __name__ == "__main__":
    print(greet("Python"))
```

---

## 🚀 実行方法（Remote - Containers）

1. VSCode でプロジェクトルートを開く
2. 左下の「><」マーク → "Reopen in Container"
3. 自動的にコンテナがビルドされ、Poetryで依存がインストールされます
4. コンテナの中で以下が実行可能：

```bash
poetry run python src/main.py
poetry run pytest
poetry run mypy src/
```

---

## ✅ 補足

* `.devcontainer/` をGit管理すればチームで環境統一が可能
* `poetry add XXX` でライブラリ追加（例：requests）
* Poetry仮想環境をDocker外に作りたい場合は `POETRY_VIRTUALENVS_CREATE=true` に変更



